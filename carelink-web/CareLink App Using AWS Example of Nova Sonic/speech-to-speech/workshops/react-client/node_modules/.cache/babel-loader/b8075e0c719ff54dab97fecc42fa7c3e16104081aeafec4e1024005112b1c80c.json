{"ast":null,"code":"var _jsxFileName = \"/Users/jonathanfox/Desktop/amazon-nova-samples/speech-to-speech/workshops/react-client/src/s2s.js\";\nimport React, { createRef } from 'react';\nimport './s2s.css';\nimport { Icon, Alert, Button, Modal, Box, SpaceBetween, Container, ColumnLayout, Header, FormField, Select, Textarea, Checkbox } from '@cloudscape-design/components';\nimport S2sEvent from './helper/s2sEvents';\nimport { base64LPCM } from './helper/audioHelper';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nclass S2sChatBot extends React.Component {\n  constructor(props) {\n    super(props);\n    this.handleSessionChange = e => {\n      let customPrompt = localStorage.getItem('carelink_summary');\n      const DEFAULT_PROMPT = S2sEvent.DEFAULT_SYSTEM_PROMPT;\n      if (customPrompt && typeof customPrompt === 'string') {\n        customPrompt = customPrompt.trim().slice(0, 1000);\n      }\n      if (!customPrompt) {\n        customPrompt = DEFAULT_PROMPT;\n      }\n\n      // Get vitals history\n      let vitalsHistory = [];\n      try {\n        vitalsHistory = JSON.parse(localStorage.getItem('carelink_vitals') || '[]');\n      } catch (e) {\n        vitalsHistory = [];\n      }\n      // Limit to last 10 records\n      const vitalsToSend = vitalsHistory.slice(-10);\n      let vitalsString = '';\n      if (vitalsToSend.length > 0) {\n        vitalsString = '\\n\\nRecent vitals history (timestamp, heart_rate, blood_oxygen, temperature):\\n' + vitalsToSend.map(v => `${v.timestamp}, ${v.heart_rate}, ${v.blood_oxygen}, ${v.temperature}`).join('\\n');\n      }\n\n      // Combine summary and vitals\n      const fullPrompt = (customPrompt + vitalsString).slice(0, 1800); // Limit total length\n\n      if (this.state.sessionStarted) {\n        this.endSession();\n        this.cancelAudio();\n        this.setState({\n          sessionStarted: false\n        });\n      } else {\n        this.setState({\n          configSystemPrompt: fullPrompt,\n          chatMessages: [],\n          events: [],\n          eventsByContentName: []\n        }, () => {\n          this.startSession();\n          this.setState({\n            sessionStarted: true\n          });\n        });\n      }\n    };\n    this.state = {\n      status: \"loading\",\n      // null, loading, loaded\n      alert: null,\n      sessionStarted: false,\n      showEventJson: false,\n      showConfig: false,\n      selectedEvent: null,\n      chatMessages: {},\n      events: [],\n      audioResponse: [],\n      eventsByContentName: [],\n      audioChunks: [],\n      audioInputIndex: 0,\n      audioPlayPromise: null,\n      includeChatHistory: false,\n      // S2S config items\n      configAudioInput: null,\n      configSystemPrompt: S2sEvent.DEFAULT_SYSTEM_PROMPT,\n      configAudioOutput: S2sEvent.DEFAULT_AUDIO_OUTPUT_CONFIG,\n      configVoiceIdOption: {\n        label: \"Matthew (en-US)\",\n        value: \"matthew\"\n      },\n      configToolUse: JSON.stringify(S2sEvent.DEFAULT_TOOL_CONFIG, null, 2),\n      configChatHistory: JSON.stringify(S2sEvent.DEFAULT_CHAT_HISTORY, null, 2)\n    };\n    this.socket = null;\n    this.mediaRecorder = null;\n    //this.audioQueue = new AudioQueue();\n    this.chatMessagesEndRef = /*#__PURE__*/React.createRef();\n    this.audioPlayerRef = /*#__PURE__*/createRef();\n    this.audioQueue = [];\n    this.promptName = null;\n    this.textContentName = null;\n    this.audioContentName = null;\n  }\n  componentDidMount() {\n    //this.connectWebSocket();\n  }\n  componentDidUpdate(prevProps, prevState) {\n    if (prevState.chatMessages.length !== this.state.chatMessages.length) {\n      var _this$chatMessagesEnd;\n      (_this$chatMessagesEnd = this.chatMessagesEndRef.current) === null || _this$chatMessagesEnd === void 0 ? void 0 : _this$chatMessagesEnd.scrollIntoView({\n        behavior: 'smooth'\n      });\n    }\n  }\n  sendEvent(event) {\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n      this.socket.send(JSON.stringify(event));\n      event.timestamp = Date.now();\n      this.displayEvent(event, \"out\");\n    }\n  }\n  cancelAudio() {\n    try {\n      if (this.audioPlayerRef.current && this.state.audioPlayPromise) {\n        this.audioPlayerRef.current.pause();\n        this.audioPlayerRef.current.currentTime = 0;\n        //this.audioPlayerRef.current.removeAttribute('src');\n        this.setState({\n          audioPlayPromise: null\n        });\n      }\n      this.audioQueue = [];\n      this.setState({\n        isPlaying: false\n      });\n    } catch (err) {\n      console.log(err);\n    }\n  }\n  audioEnqueue(audioUrl) {\n    this.audioQueue.push(audioUrl);\n    if (!this.state.isPlaying) {\n      this.playNext();\n    }\n  }\n  playNext() {\n    try {\n      if (this.isPlaying || this.audioQueue.length === 0) return;\n      if (this.audioPlayerRef.current && this.audioQueue.length > 0) {\n        let audioUrl = this.audioQueue.shift();\n        this.setState({\n          isPlaying: true\n        });\n        try {\n          this.audioPlayerRef.current.src = audioUrl;\n          this.audioPlayerRef.current.load(); // Reload the audio element to apply the new src\n          this.setState({\n            audioPlayPromise: this.audioPlayerRef.current.play().catch(err => {})\n          });\n        } catch (err) {\n          console.log(err);\n        }\n\n        // Wait for the audio to finish, then play the next one\n        this.audioPlayerRef.current.onended = () => {\n          this.setState({\n            isPlaying: false\n          });\n          this.playNext();\n        };\n      }\n    } catch (error) {\n      console.log(error);\n    }\n  }\n  handleIncomingMessage(message) {\n    const eventType = Object.keys(message === null || message === void 0 ? void 0 : message.event)[0];\n    const role = message.event[eventType][\"role\"];\n    const content = message.event[eventType][\"content\"];\n    const contentId = message.event[eventType].contentId;\n    let stopReason = message.event[eventType].stopReason;\n    const contentType = message.event[eventType].type;\n    var chatMessages = this.state.chatMessages;\n    var audioResponse = this.state.audioResponse;\n    switch (eventType) {\n      case \"textOutput\":\n        // Detect interruption\n        if (role === \"ASSISTANT\" && content.startsWith(\"{\")) {\n          const evt = JSON.parse(content);\n          if (evt.interrupted === true) {\n            this.cancelAudio();\n          }\n        }\n        if (chatMessages.hasOwnProperty(contentId)) {\n          chatMessages[contentId].content = content;\n          chatMessages[contentId].role = role;\n          if (chatMessages[contentId].raw === undefined) chatMessages[contentId].raw = [];\n          chatMessages[contentId].raw.push(message);\n        }\n        this.setState({\n          chatMessages: chatMessages\n        });\n        break;\n      case \"audioOutput\":\n        audioResponse[contentId] += message.event[eventType].content;\n        this.setState({\n          audioResponse: audioResponse\n        });\n        //this.state.audioResponse[contentId] += message.event[eventType].content;\n        break;\n      case \"contentStart\":\n        if (contentType === \"AUDIO\") {\n          audioResponse[contentId] = \"\";\n          this.setState({\n            audioResponse: audioResponse\n          });\n        } else if (contentType === \"TEXT\") {\n          var generationStage = \"\";\n          if (message.event.contentStart.additionalModelFields) {\n            var _JSON$parse;\n            generationStage = (_JSON$parse = JSON.parse(message.event.contentStart.additionalModelFields)) === null || _JSON$parse === void 0 ? void 0 : _JSON$parse.generationStage;\n          }\n          chatMessages[contentId] = {\n            \"content\": \"\",\n            \"role\": role,\n            \"generationStage\": generationStage,\n            \"raw\": []\n          };\n          chatMessages[contentId].raw.push(message);\n          this.setState({\n            chatMessages: chatMessages\n          });\n        }\n        break;\n      case \"contentEnd\":\n        if (contentType === \"AUDIO\") {\n          var audioUrl = base64LPCM(this.state.audioResponse[contentId]);\n          this.audioEnqueue(audioUrl);\n          //this.audioQueue.enqueue(audioUrl);\n        } else if (contentType === \"TEXT\") {\n          if (chatMessages.hasOwnProperty(contentId)) {\n            if (chatMessages[contentId].raw === undefined) chatMessages[contentId].raw = [];\n            chatMessages[contentId].raw.push(message);\n            chatMessages[contentId].stopReason = stopReason;\n          }\n          this.setState({\n            chatMessages: chatMessages\n          });\n        }\n        break;\n      default:\n        break;\n    }\n    this.displayEvent(message, \"in\");\n  }\n  displayEvent(event, type) {\n    if (event && event.event) {\n      const eventName = Object.keys(event === null || event === void 0 ? void 0 : event.event)[0];\n      let key = null;\n      let ts = Date.now();\n      let interrupted = false;\n      const contentType = event.event[eventName].type;\n      const contentName = event.event[eventName].contentName;\n      const contentId = event.event[eventName].contentId;\n      if (eventName === \"audioOutput\") {\n        key = `${eventName}-${contentId}`;\n        // truncate event audio content\n        event.event.audioOutput.content = event.event.audioOutput.content.substr(0, 10);\n      } else if (eventName === \"audioInput\") {\n        key = `${eventName}-${contentName}-${this.state.audioInputIndex}`;\n      } else if (eventName === \"contentStart\" || eventName === \"textInput\" || eventName === \"contentEnd\") {\n        key = `${eventName}}-${contentName}-${contentType}`;\n        if (type === \"in\" && event.event[eventName].type === \"AUDIO\") {\n          this.setState({\n            audioInputIndex: this.state.audioInputIndex + 1\n          });\n        } else if (type === \"out\") {\n          key = `${eventName}-${contentName}-${contentType}-${ts}`;\n        }\n      } else if (eventName === \"textOutput\") {\n        const role = event.event[eventName].role;\n        const content = event.event[eventName].content;\n        if (role === \"ASSISTANT\" && content.startsWith(\"{\")) {\n          const evt = JSON.parse(content);\n          interrupted = evt.interrupted === true;\n        }\n        key = `${eventName}-${ts}`;\n      } else {\n        key = `${eventName}-${ts}`;\n      }\n      let eventsByContentName = this.state.eventsByContentName;\n      if (eventsByContentName === null) eventsByContentName = [];\n      let exists = false;\n      for (var i = 0; i < eventsByContentName.length; i++) {\n        var item = eventsByContentName[i];\n        if (item.key === key && item.type === type) {\n          item.events.push(event);\n          item.interrupted = interrupted;\n          exists = true;\n          break;\n        }\n      }\n      if (!exists) {\n        const item = {\n          key: key,\n          name: eventName,\n          type: type,\n          events: [event],\n          ts: ts\n        };\n        eventsByContentName.unshift(item);\n      }\n      this.setState({\n        eventsByContentName: eventsByContentName\n      });\n    }\n  }\n  connectWebSocket() {\n    // Connect to the S2S WebSocket server\n    if (this.socket === null || this.socket.readyState !== WebSocket.OPEN) {\n      this.socket = new WebSocket(process.env.REACT_APP_WEBSOCKET_URL);\n      this.socket.onopen = () => {\n        console.log(\"WebSocket connected!\");\n        this.promptName = crypto.randomUUID();\n        this.textContentName = crypto.randomUUID();\n        this.audioContentName = crypto.randomUUID();\n\n        // Start session events\n        this.sendEvent(S2sEvent.sessionStart());\n        var audioConfig = S2sEvent.DEFAULT_AUDIO_OUTPUT_CONFIG;\n        audioConfig.voiceId = this.state.configVoiceIdOption.value;\n        var toolConfig = this.state.configToolUse ? JSON.parse(this.state.configToolUse) : S2sEvent.DEFAULT_TOOL_CONFIG;\n        this.sendEvent(S2sEvent.promptStart(this.promptName, audioConfig, toolConfig));\n        this.sendEvent(S2sEvent.contentStartText(this.promptName, this.textContentName));\n        this.sendEvent(S2sEvent.textInput(this.promptName, this.textContentName, this.state.configSystemPrompt));\n        this.sendEvent(S2sEvent.contentEnd(this.promptName, this.textContentName));\n\n        // Chat history\n        if (this.state.includeChatHistory) {\n          var chatHistory = JSON.parse(this.state.configChatHistory);\n          if (chatHistory === null) chatHistory = S2sEvent.DEFAULT_CHAT_HISTORY;\n          for (const chat of chatHistory) {\n            const chatHistoryContentName = crypto.randomUUID();\n            this.sendEvent(S2sEvent.contentStartText(this.promptName, chatHistoryContentName, chat.role));\n            this.sendEvent(S2sEvent.textInput(this.promptName, chatHistoryContentName, chat.content));\n            this.sendEvent(S2sEvent.contentEnd(this.promptName, chatHistoryContentName));\n          }\n        }\n        this.sendEvent(S2sEvent.contentStartAudio(this.promptName, this.audioContentName));\n      };\n\n      // Handle incoming messages\n      this.socket.onmessage = message => {\n        const event = JSON.parse(message.data);\n        this.handleIncomingMessage(event);\n      };\n\n      // Handle errors\n      this.socket.onerror = error => {\n        this.setState({\n          alert: \"WebSocket Error: \",\n          error\n        });\n        console.error(\"WebSocket Error: \", error);\n      };\n\n      // Handle connection close\n      this.socket.onclose = () => {\n        console.log(\"WebSocket Disconnected\");\n        if (this.state.sessionStarted) this.setState({\n          alert: \"WebSocket Disconnected\"\n        });\n      };\n    }\n  }\n  startSession() {\n    // Init S2sSessionManager\n    try {\n      if (this.socket === null || this.socket.readyState !== WebSocket.OPEN) {\n        this.connectWebSocket();\n      }\n\n      // Start microphone \n      this.startMicrophone();\n    } catch (error) {\n      console.error('Error accessing microphone: ', error);\n    }\n  }\n  async startMicrophone() {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        audio: {\n          echoCancellation: true,\n          noiseSuppression: true,\n          autoGainControl: true\n        }\n      });\n      const audioContext = new (window.AudioContext || window.webkitAudioContext)({\n        latencyHint: 'interactive'\n      });\n      const source = audioContext.createMediaStreamSource(stream);\n      const processor = audioContext.createScriptProcessor(512, 1, 1);\n      source.connect(processor);\n      processor.connect(audioContext.destination);\n      const targetSampleRate = 16000;\n      processor.onaudioprocess = async e => {\n        if (this.state.sessionStarted) {\n          const inputBuffer = e.inputBuffer;\n\n          // Create an offline context for resampling\n          const offlineContext = new OfflineAudioContext({\n            numberOfChannels: 1,\n            length: Math.ceil(inputBuffer.duration * targetSampleRate),\n            sampleRate: targetSampleRate\n          });\n\n          // Copy input to offline context buffer\n          const offlineSource = offlineContext.createBufferSource();\n          const monoBuffer = offlineContext.createBuffer(1, inputBuffer.length, inputBuffer.sampleRate);\n          monoBuffer.copyToChannel(inputBuffer.getChannelData(0), 0);\n          offlineSource.buffer = monoBuffer;\n          offlineSource.connect(offlineContext.destination);\n          offlineSource.start(0);\n\n          // Resample and get the rendered buffer\n          const renderedBuffer = await offlineContext.startRendering();\n          const resampled = renderedBuffer.getChannelData(0);\n\n          // Convert to Int16 PCM\n          const buffer = new ArrayBuffer(resampled.length * 2);\n          const pcmData = new DataView(buffer);\n          for (let i = 0; i < resampled.length; i++) {\n            const s = Math.max(-1, Math.min(1, resampled[i]));\n            pcmData.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);\n          }\n\n          // Convert to binary string and base64 encode\n          let binary = '';\n          for (let i = 0; i < pcmData.byteLength; i++) {\n            binary += String.fromCharCode(pcmData.getUint8(i));\n          }\n          const event = S2sEvent.audioInput(this.promptName, this.audioContentName, btoa(binary));\n          this.sendEvent(event);\n        }\n      };\n      window.audioCleanup = () => {\n        processor.disconnect();\n        source.disconnect();\n        stream.getTracks().forEach(track => track.stop());\n      };\n      this.mediaRecorder = new MediaRecorder(stream);\n      this.mediaRecorder.ondataavailable = event => {\n        this.state.audioChunks.push(event.data);\n      };\n      this.mediaRecorder.onstop = () => {\n        const audioBlob = new Blob(this.state.audioChunks, {\n          type: 'audio/webm'\n        });\n        this.sendEvent(S2sEvent.audioInput(this.promptName, this.audioContentName, btoa(audioBlob)));\n        this.setState({\n          audioChunks: []\n        });\n      };\n      this.mediaRecorder.start();\n      this.setState({\n        sessionStarted: true\n      });\n      console.log('Microphone recording started');\n    } catch (error) {\n      console.error('Error accessing microphone: ', error);\n    }\n  }\n  endSession() {\n    if (this.socket) {\n      // Close microphone\n      if (this.mediaRecorder && this.state.sessionStarted) {\n        this.mediaRecorder.stop();\n        console.log('Microphone recording stopped');\n      }\n\n      // Close S2sSessionManager\n      this.sendEvent(S2sEvent.contentEnd(this.promptName, this.audioContentName));\n      this.sendEvent(S2sEvent.promptEnd(this.promptName));\n      this.sendEvent(S2sEvent.sessionEnd());\n\n      // Close websocket\n      this.socket.close();\n      this.setState({\n        sessionStarted: false\n      });\n    }\n  }\n  render() {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"s2s\",\n      children: [this.state.alert !== null && this.state.alert.length > 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n        children: [/*#__PURE__*/_jsxDEV(Alert, {\n          statusIconAriaLabel: \"Warning\",\n          type: \"warning\",\n          children: this.state.alert\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 514,\n          columnNumber: 22\n        }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 516,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 514,\n        columnNumber: 17\n      }, this) : /*#__PURE__*/_jsxDEV(\"div\", {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 516,\n        columnNumber: 37\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"top\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"action\",\n          children: [/*#__PURE__*/_jsxDEV(Button, {\n            variant: \"primary\",\n            onClick: this.handleSessionChange,\n            children: [/*#__PURE__*/_jsxDEV(Icon, {\n              name: this.state.sessionStarted ? \"microphone-off\" : \"microphone\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 520,\n              columnNumber: 29\n            }, this), \"\\xA0\\xA0\", this.state.sessionStarted ? \"End Conversation\" : \"Start Conversation\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 519,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"chathistory\",\n            children: [/*#__PURE__*/_jsxDEV(Checkbox, {\n              checked: this.state.includeChatHistory,\n              onChange: ({\n                detail\n              }) => this.setState({\n                includeChatHistory: detail.checked\n              }),\n              children: \"Include chat history\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 524,\n              columnNumber: 29\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"desc\",\n              children: \"You can view sample chat history in the settings.\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 525,\n              columnNumber: 29\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 523,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(\"audio\", {\n            ref: this.audioPlayerRef\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 527,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 518,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"setting\",\n          children: /*#__PURE__*/_jsxDEV(Button, {\n            onClick: () => this.setState({\n              showConfig: true\n            }),\n            children: /*#__PURE__*/_jsxDEV(Icon, {\n              name: \"settings\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 535,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 530,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 529,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 517,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 540,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(ColumnLayout, {\n        columns: 2,\n        children: [/*#__PURE__*/_jsxDEV(Container, {\n          header: /*#__PURE__*/_jsxDEV(Header, {\n            variant: \"h2\",\n            children: \"Conversation\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 543,\n            columnNumber: 25\n          }, this),\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"chatarea\",\n            children: [Object.keys(this.state.chatMessages).map((key, index) => {\n              const msg = this.state.chatMessages[key];\n              //if (msg.stopReason === \"END_TURN\" || msg.role === \"USER\")\n              return /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"item\",\n                children: /*#__PURE__*/_jsxDEV(\"div\", {\n                  className: msg.role === \"USER\" ? \"user\" : \"bot\",\n                  onClick: () => this.setState({\n                    showEventJson: true,\n                    selectedEvent: {\n                      events: msg.raw\n                    }\n                  }),\n                  children: [/*#__PURE__*/_jsxDEV(Icon, {\n                    name: msg.role === \"USER\" ? \"user-profile\" : \"gen-ai\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 556,\n                    columnNumber: 41\n                  }, this), \"\\xA0\\xA0\", msg.content, msg.role === \"ASSISTANT\" && msg.generationStage ? ` [${msg.generationStage}]` : \"\"]\n                }, void 0, true, {\n                  fileName: _jsxFileName,\n                  lineNumber: 550,\n                  columnNumber: 37\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 549,\n                columnNumber: 40\n              }, this);\n            }), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"endbar\",\n              ref: this.chatMessagesEndRef\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 562,\n              columnNumber: 25\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 545,\n            columnNumber: 21\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 542,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Container, {\n          header: /*#__PURE__*/_jsxDEV(Header, {\n            variant: \"h2\",\n            children: \"Events\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 566,\n            columnNumber: 25\n          }, this),\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"events\",\n            children: [this.state.eventsByContentName.map(event => {\n              return /*#__PURE__*/_jsxDEV(\"div\", {\n                className: event.name === \"toolUse\" ? \"event-tool\" : event.interrupted === true ? \"event-int\" : event.type === \"in\" ? \"event-in\" : \"event-out\",\n                onClick: () => {\n                  this.setState({\n                    selectedEvent: event,\n                    showEventJson: true\n                  });\n                },\n                children: [/*#__PURE__*/_jsxDEV(Icon, {\n                  name: event.type === \"in\" ? \"arrow-down\" : \"arrow-up\"\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 579,\n                  columnNumber: 33\n                }, this), \"\\xA0\\xA0\", event.name, event.events.length > 1 ? ` (${event.events.length})` : \"\", /*#__PURE__*/_jsxDEV(\"div\", {\n                  class: \"tooltip\",\n                  children: /*#__PURE__*/_jsxDEV(\"pre\", {\n                    id: \"jsonDisplay\",\n                    children: event.events.map(e => {\n                      return JSON.stringify(e, null, 2);\n                    })\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 583,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 582,\n                  columnNumber: 33\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 570,\n                columnNumber: 36\n              }, this);\n            }), /*#__PURE__*/_jsxDEV(Modal, {\n              onDismiss: () => this.setState({\n                showEventJson: false\n              }),\n              visible: this.state.showEventJson,\n              header: \"Event details\",\n              size: \"medium\",\n              footer: /*#__PURE__*/_jsxDEV(Box, {\n                float: \"right\",\n                children: /*#__PURE__*/_jsxDEV(SpaceBetween, {\n                  direction: \"horizontal\",\n                  size: \"xs\",\n                  children: /*#__PURE__*/_jsxDEV(Button, {\n                    variant: \"link\",\n                    onClick: () => this.setState({\n                      showEventJson: false\n                    }),\n                    children: \"Close\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 598,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 597,\n                  columnNumber: 33\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 596,\n                columnNumber: 33\n              }, this),\n              children: /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"eventdetail\",\n                children: /*#__PURE__*/_jsxDEV(\"pre\", {\n                  id: \"jsonDisplay\",\n                  children: this.state.selectedEvent && this.state.selectedEvent.events.map(e => {\n                    const eventType = Object.keys(e === null || e === void 0 ? void 0 : e.event)[0];\n                    if (eventType === \"audioInput\" || eventType === \"audioOutput\") e.event[eventType].content = e.event[eventType].content.substr(0, 10) + \"...\";\n                    const ts = new Date(e.timestamp).toLocaleString(undefined, {\n                      year: \"numeric\",\n                      month: \"2-digit\",\n                      day: \"2-digit\",\n                      hour: \"2-digit\",\n                      minute: \"2-digit\",\n                      second: \"2-digit\",\n                      fractionalSecondDigits: 3,\n                      // Show milliseconds\n                      hour12: false // 24-hour format\n                    });\n                    var displayJson = {\n                      ...e\n                    };\n                    delete displayJson.timestamp;\n                    return ts + \"\\n\" + JSON.stringify(displayJson, null, 2) + \"\\n\";\n                  })\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 604,\n                  columnNumber: 29\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 603,\n                columnNumber: 29\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 590,\n              columnNumber: 25\n            }, this), /*#__PURE__*/_jsxDEV(Modal, {\n              onDismiss: () => this.setState({\n                showConfig: false\n              }),\n              visible: this.state.showConfig,\n              header: \"Nova S2S settings\",\n              size: \"large\",\n              footer: /*#__PURE__*/_jsxDEV(Box, {\n                float: \"right\",\n                children: /*#__PURE__*/_jsxDEV(SpaceBetween, {\n                  direction: \"horizontal\",\n                  size: \"xs\",\n                  children: /*#__PURE__*/_jsxDEV(Button, {\n                    variant: \"link\",\n                    onClick: () => this.setState({\n                      showConfig: false\n                    }),\n                    children: \"Save\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 634,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 633,\n                  columnNumber: 33\n                }, this)\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 632,\n                columnNumber: 33\n              }, this),\n              children: /*#__PURE__*/_jsxDEV(\"div\", {\n                className: \"config\",\n                children: [/*#__PURE__*/_jsxDEV(FormField, {\n                  label: \"Voice Id\",\n                  stretch: true,\n                  children: /*#__PURE__*/_jsxDEV(Select, {\n                    selectedOption: this.state.configVoiceIdOption,\n                    onChange: ({\n                      detail\n                    }) => this.setState({\n                      configVoiceIdOption: detail.selectedOption\n                    }),\n                    options: [{\n                      label: \"Matthew (en-US)\",\n                      value: \"matthew\"\n                    }, {\n                      label: \"Tiffany (en-US)\",\n                      value: \"tiffany\"\n                    }, {\n                      label: \"Amy (en-GB)\",\n                      value: \"amy\"\n                    }]\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 644,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 640,\n                  columnNumber: 33\n                }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 656,\n                  columnNumber: 33\n                }, this), /*#__PURE__*/_jsxDEV(FormField, {\n                  label: \"System prompt\",\n                  description: \"For the speech model\",\n                  stretch: true,\n                  children: /*#__PURE__*/_jsxDEV(Textarea, {\n                    onChange: ({\n                      detail\n                    }) => this.setState({\n                      configSystemPrompt: detail.value\n                    }),\n                    value: this.state.configSystemPrompt,\n                    placeholder: \"Speech system prompt\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 662,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 657,\n                  columnNumber: 33\n                }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 668,\n                  columnNumber: 33\n                }, this), /*#__PURE__*/_jsxDEV(FormField, {\n                  label: \"Tool use configuration\",\n                  description: \"For external integration such as RAG and Agents\",\n                  stretch: true,\n                  children: /*#__PURE__*/_jsxDEV(Textarea, {\n                    onChange: ({\n                      detail\n                    }) => this.setState({\n                      configToolUse: detail.value\n                    }),\n                    value: this.state.configToolUse,\n                    rows: 10,\n                    placeholder: \"{}\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 674,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 669,\n                  columnNumber: 33\n                }, this), /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 681,\n                  columnNumber: 41\n                }, this), /*#__PURE__*/_jsxDEV(FormField, {\n                  label: \"Chat history\",\n                  description: \"Sample chat history to resume conversation\",\n                  stretch: true,\n                  children: /*#__PURE__*/_jsxDEV(Textarea, {\n                    onChange: ({\n                      detail\n                    }) => this.setState({\n                      configChatHistory: detail.value\n                    }),\n                    value: this.state.configChatHistory,\n                    rows: 15,\n                    placeholder: \"{}\"\n                  }, void 0, false, {\n                    fileName: _jsxFileName,\n                    lineNumber: 687,\n                    columnNumber: 37\n                  }, this)\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 682,\n                  columnNumber: 33\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 639,\n                columnNumber: 29\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 626,\n              columnNumber: 25\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 568,\n            columnNumber: 21\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 565,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 541,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 512,\n      columnNumber: 13\n    }, this);\n  }\n}\nexport default S2sChatBot;","map":{"version":3,"names":["React","createRef","Icon","Alert","Button","Modal","Box","SpaceBetween","Container","ColumnLayout","Header","FormField","Select","Textarea","Checkbox","S2sEvent","base64LPCM","jsxDEV","_jsxDEV","S2sChatBot","Component","constructor","props","handleSessionChange","e","customPrompt","localStorage","getItem","DEFAULT_PROMPT","DEFAULT_SYSTEM_PROMPT","trim","slice","vitalsHistory","JSON","parse","vitalsToSend","vitalsString","length","map","v","timestamp","heart_rate","blood_oxygen","temperature","join","fullPrompt","state","sessionStarted","endSession","cancelAudio","setState","configSystemPrompt","chatMessages","events","eventsByContentName","startSession","status","alert","showEventJson","showConfig","selectedEvent","audioResponse","audioChunks","audioInputIndex","audioPlayPromise","includeChatHistory","configAudioInput","configAudioOutput","DEFAULT_AUDIO_OUTPUT_CONFIG","configVoiceIdOption","label","value","configToolUse","stringify","DEFAULT_TOOL_CONFIG","configChatHistory","DEFAULT_CHAT_HISTORY","socket","mediaRecorder","chatMessagesEndRef","audioPlayerRef","audioQueue","promptName","textContentName","audioContentName","componentDidMount","componentDidUpdate","prevProps","prevState","_this$chatMessagesEnd","current","scrollIntoView","behavior","sendEvent","event","readyState","WebSocket","OPEN","send","Date","now","displayEvent","pause","currentTime","isPlaying","err","console","log","audioEnqueue","audioUrl","push","playNext","shift","src","load","play","catch","onended","error","handleIncomingMessage","message","eventType","Object","keys","role","content","contentId","stopReason","contentType","type","startsWith","evt","interrupted","hasOwnProperty","raw","undefined","generationStage","contentStart","additionalModelFields","_JSON$parse","eventName","key","ts","contentName","audioOutput","substr","exists","i","item","name","unshift","connectWebSocket","process","env","REACT_APP_WEBSOCKET_URL","onopen","crypto","randomUUID","sessionStart","audioConfig","voiceId","toolConfig","promptStart","contentStartText","textInput","contentEnd","chatHistory","chat","chatHistoryContentName","contentStartAudio","onmessage","data","onerror","onclose","startMicrophone","stream","navigator","mediaDevices","getUserMedia","audio","echoCancellation","noiseSuppression","autoGainControl","audioContext","window","AudioContext","webkitAudioContext","latencyHint","source","createMediaStreamSource","processor","createScriptProcessor","connect","destination","targetSampleRate","onaudioprocess","inputBuffer","offlineContext","OfflineAudioContext","numberOfChannels","Math","ceil","duration","sampleRate","offlineSource","createBufferSource","monoBuffer","createBuffer","copyToChannel","getChannelData","buffer","start","renderedBuffer","startRendering","resampled","ArrayBuffer","pcmData","DataView","s","max","min","setInt16","binary","byteLength","String","fromCharCode","getUint8","audioInput","btoa","audioCleanup","disconnect","getTracks","forEach","track","stop","MediaRecorder","ondataavailable","onstop","audioBlob","Blob","promptEnd","sessionEnd","close","render","className","children","statusIconAriaLabel","fileName","_jsxFileName","lineNumber","columnNumber","variant","onClick","checked","onChange","detail","ref","columns","header","index","msg","class","id","onDismiss","visible","size","footer","float","direction","toLocaleString","year","month","day","hour","minute","second","fractionalSecondDigits","hour12","displayJson","stretch","selectedOption","options","description","placeholder","rows"],"sources":["/Users/jonathanfox/Desktop/amazon-nova-samples/speech-to-speech/workshops/react-client/src/s2s.js"],"sourcesContent":["import React, { createRef } from 'react';\nimport './s2s.css'\nimport { Icon, Alert, Button, Modal, Box, SpaceBetween, Container, ColumnLayout, Header, FormField, Select, Textarea, Checkbox } from '@cloudscape-design/components';\nimport S2sEvent from './helper/s2sEvents';\nimport {base64LPCM} from './helper/audioHelper';\n\nclass S2sChatBot extends React.Component {\n\n    constructor(props) {\n        super(props);\n        this.state = {\n            status: \"loading\", // null, loading, loaded\n            alert: null,\n            sessionStarted: false,\n            showEventJson: false,\n            showConfig: false,\n            selectedEvent: null,\n\n            chatMessages: {},\n            events: [],\n            audioResponse: [],\n            eventsByContentName: [],\n            audioChunks: [],\n            audioInputIndex: 0,\n            audioPlayPromise: null,\n            includeChatHistory: false,\n\n            // S2S config items\n            configAudioInput: null,\n            configSystemPrompt: S2sEvent.DEFAULT_SYSTEM_PROMPT,\n            configAudioOutput: S2sEvent.DEFAULT_AUDIO_OUTPUT_CONFIG,\n            configVoiceIdOption: { label: \"Matthew (en-US)\", value: \"matthew\" },\n            configToolUse: JSON.stringify(S2sEvent.DEFAULT_TOOL_CONFIG, null, 2),\n            configChatHistory: JSON.stringify(S2sEvent.DEFAULT_CHAT_HISTORY, null, 2),\n        };\n        this.socket = null;\n        this.mediaRecorder = null;\n        //this.audioQueue = new AudioQueue();\n        this.chatMessagesEndRef = React.createRef();\n        this.audioPlayerRef = createRef();\n        this.audioQueue = [];\n\n        this.promptName = null;\n        this.textContentName = null;\n        this.audioContentName = null;\n    }\n\n    componentDidMount() {\n        //this.connectWebSocket();\n    }\n\n    componentDidUpdate(prevProps, prevState) {\n        if (prevState.chatMessages.length !== this.state.chatMessages.length) {\n            this.chatMessagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n        }\n    }\n    \n    sendEvent(event) {\n        if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n            this.socket.send(JSON.stringify(event));\n            event.timestamp = Date.now();\n            this.displayEvent(event, \"out\");\n        }\n    }\n    \n    cancelAudio() {\n        try {\n            if (this.audioPlayerRef.current && this.state.audioPlayPromise) {\n                this.audioPlayerRef.current.pause();\n                this.audioPlayerRef.current.currentTime = 0;\n                //this.audioPlayerRef.current.removeAttribute('src');\n                this.setState({audioPlayPromise: null});\n              }\n              this.audioQueue = []\n              this.setState({\n                isPlaying: false,\n              });\n        }\n        catch(err) {\n            console.log(err);\n        }\n    }\n\n    audioEnqueue(audioUrl) {\n        this.audioQueue.push(audioUrl);\n        if (!this.state.isPlaying) {\n            this.playNext();\n        }\n    }\n\n    playNext() {\n        try{\n            if (this.isPlaying || this.audioQueue.length === 0) return;\n        \n            if (this.audioPlayerRef.current && this.audioQueue.length > 0) {\n                let audioUrl  = this.audioQueue.shift();\n                this.setState({ isPlaying: true});\n\n                try {\n                    this.audioPlayerRef.current.src = audioUrl;\n                    this.audioPlayerRef.current.load();  // Reload the audio element to apply the new src\n                    this.setState({audioPlayPromise: this.audioPlayerRef.current.play().catch((err) => {})}); \n                }\n                catch(err) {\n                    console.log(err);\n                }\n                \n                // Wait for the audio to finish, then play the next one\n                this.audioPlayerRef.current.onended = () => {\n                    this.setState({ isPlaying: false});\n                    this.playNext();\n                };\n            }\n        }\n        catch (error) {\n            console.log(error);\n        }\n    }\n    handleIncomingMessage (message) {\n        const eventType = Object.keys(message?.event)[0];\n        const role = message.event[eventType][\"role\"];\n        const content = message.event[eventType][\"content\"];\n        const contentId = message.event[eventType].contentId;\n        let stopReason = message.event[eventType].stopReason;\n        const contentType = message.event[eventType].type;\n        var chatMessages = this.state.chatMessages;\n        var audioResponse = this.state.audioResponse;\n\n        switch(eventType) {\n            case \"textOutput\": \n                // Detect interruption\n                if (role === \"ASSISTANT\" && content.startsWith(\"{\")) {\n                    const evt = JSON.parse(content);\n                    if (evt.interrupted === true) {\n                        this.cancelAudio()\n                    }\n                }\n\n                if (chatMessages.hasOwnProperty(contentId)) {\n                    chatMessages[contentId].content = content;\n                    chatMessages[contentId].role = role;\n                    if (chatMessages[contentId].raw === undefined)\n                        chatMessages[contentId].raw = [];\n                    chatMessages[contentId].raw.push(message);\n                }\n                this.setState({chatMessages: chatMessages});\n                break;\n            case \"audioOutput\":\n                audioResponse[contentId] += message.event[eventType].content;\n                this.setState({audioResponse: audioResponse});\n                //this.state.audioResponse[contentId] += message.event[eventType].content;\n                break;\n            case \"contentStart\":\n                if (contentType === \"AUDIO\") {\n                    audioResponse[contentId] = \"\";\n                    this.setState({audioResponse: audioResponse});\n                }\n                else if (contentType === \"TEXT\") {\n                    var generationStage = \"\";\n                    if (message.event.contentStart.additionalModelFields) {\n                        generationStage = JSON.parse(message.event.contentStart.additionalModelFields)?.generationStage;\n                    }\n\n                    chatMessages[contentId] =  {\n                        \"content\": \"\", \n                        \"role\": role,\n                        \"generationStage\": generationStage,\n                        \"raw\": [],\n                    };\n                    chatMessages[contentId].raw.push(message);\n                    this.setState({chatMessages: chatMessages});\n                }\n                break;\n            case \"contentEnd\":\n                if (contentType === \"AUDIO\") {\n                    var audioUrl = base64LPCM(this.state.audioResponse[contentId]);\n                    this.audioEnqueue(audioUrl);\n                    //this.audioQueue.enqueue(audioUrl);\n                }\n                else if (contentType === \"TEXT\"){\n                    if (chatMessages.hasOwnProperty(contentId)) {\n                        if (chatMessages[contentId].raw === undefined)\n                            chatMessages[contentId].raw = [];\n                        chatMessages[contentId].raw.push(message);\n                        chatMessages[contentId].stopReason = stopReason;\n                    }\n                    this.setState({chatMessages: chatMessages});\n\n                }\n                break;\n            default:\n                break;\n\n        }\n\n        this.displayEvent(message, \"in\");\n    }\n\n    displayEvent(event, type) {\n        if (event && event.event) {\n            const eventName = Object.keys(event?.event)[0];\n            let key = null;\n            let ts = Date.now();\n            let interrupted = false;\n            const contentType = event.event[eventName].type;\n            const contentName = event.event[eventName].contentName;\n            const contentId = event.event[eventName].contentId;\n\n            if (eventName === \"audioOutput\") {\n                key = `${eventName}-${contentId}`;\n                // truncate event audio content\n                event.event.audioOutput.content = event.event.audioOutput.content.substr(0,10);\n            }\n            else if (eventName === \"audioInput\") {\n                key = `${eventName}-${contentName}-${this.state.audioInputIndex}`;\n            }\n            else if (eventName === \"contentStart\" || eventName === \"textInput\" || eventName === \"contentEnd\") {\n                key = `${eventName}}-${contentName}-${contentType}`;\n                if (type === \"in\" && event.event[eventName].type === \"AUDIO\") {\n                    this.setState({audioInputIndex: this.state.audioInputIndex + 1});\n                }\n                else if(type === \"out\") {\n                    key = `${eventName}-${contentName}-${contentType}-${ts}`;\n                }\n            }\n            else if(eventName === \"textOutput\") {\n                const role = event.event[eventName].role;\n                const content = event.event[eventName].content;\n                if (role === \"ASSISTANT\" && content.startsWith(\"{\")) {\n                    const evt = JSON.parse(content);\n                    interrupted = evt.interrupted === true;\n                }\n                key = `${eventName}-${ts}`;\n            }\n            else {\n                key = `${eventName}-${ts}`;\n            }\n\n            let eventsByContentName = this.state.eventsByContentName;\n            if (eventsByContentName === null)\n                eventsByContentName = [];\n\n            let exists = false;\n            for(var i=0;i<eventsByContentName.length;i++) {\n                var item = eventsByContentName[i];\n                if (item.key === key && item.type === type) {\n                    item.events.push(event);\n\n                    item.interrupted = interrupted;\n                    exists = true;\n                    break;\n                }\n            }\n            if (!exists) {\n                const item = {\n                    key: key, \n                    name: eventName, \n                    type: type, \n                    events: [event], \n                    ts: ts,\n                };\n                eventsByContentName.unshift(item);\n            }\n            this.setState({eventsByContentName: eventsByContentName});\n        }\n    }\n\n    handleSessionChange = e => {\n        let customPrompt = localStorage.getItem('carelink_summary');\n        const DEFAULT_PROMPT = S2sEvent.DEFAULT_SYSTEM_PROMPT;\n        if (customPrompt && typeof customPrompt === 'string') {\n            customPrompt = customPrompt.trim().slice(0, 1000);\n        }\n        if (!customPrompt) {\n            customPrompt = DEFAULT_PROMPT;\n        }\n\n        // Get vitals history\n        let vitalsHistory = [];\n        try {\n            vitalsHistory = JSON.parse(localStorage.getItem('carelink_vitals') || '[]');\n        } catch (e) {\n            vitalsHistory = [];\n        }\n        // Limit to last 10 records\n        const vitalsToSend = vitalsHistory.slice(-10);\n        let vitalsString = '';\n        if (vitalsToSend.length > 0) {\n            vitalsString = '\\n\\nRecent vitals history (timestamp, heart_rate, blood_oxygen, temperature):\\n' +\n                vitalsToSend.map(v =>\n                    `${v.timestamp}, ${v.heart_rate}, ${v.blood_oxygen}, ${v.temperature}`\n                ).join('\\n');\n        }\n\n        // Combine summary and vitals\n        const fullPrompt = (customPrompt + vitalsString).slice(0, 1800); // Limit total length\n\n        if (this.state.sessionStarted) {\n            this.endSession();\n            this.cancelAudio();\n            this.setState({sessionStarted: false});\n        } else {\n            this.setState(\n                { configSystemPrompt: fullPrompt, chatMessages:[], events: [], eventsByContentName: [] },\n                () => {\n                    this.startSession();\n                    this.setState({sessionStarted: true});\n                }\n            );\n        }\n    }\n\n    connectWebSocket() {\n        // Connect to the S2S WebSocket server\n        if (this.socket === null || this.socket.readyState !== WebSocket.OPEN) {\n            this.socket = new WebSocket(process.env.REACT_APP_WEBSOCKET_URL);\n        \n            this.socket.onopen = () => {\n                console.log(\"WebSocket connected!\");\n                this.promptName = crypto.randomUUID();\n                this.textContentName = crypto.randomUUID();\n                this.audioContentName = crypto.randomUUID();        \n    \n                // Start session events\n                this.sendEvent(S2sEvent.sessionStart());\n\n                var audioConfig = S2sEvent.DEFAULT_AUDIO_OUTPUT_CONFIG;\n                audioConfig.voiceId = this.state.configVoiceIdOption.value;\n                var toolConfig = this.state.configToolUse?JSON.parse(this.state.configToolUse):S2sEvent.DEFAULT_TOOL_CONFIG;\n\n                this.sendEvent(S2sEvent.promptStart(this.promptName, audioConfig, toolConfig));\n\n                this.sendEvent(S2sEvent.contentStartText(this.promptName, this.textContentName));\n\n                this.sendEvent(S2sEvent.textInput(this.promptName, this.textContentName, this.state.configSystemPrompt));\n                this.sendEvent(S2sEvent.contentEnd(this.promptName, this.textContentName));\n\n                // Chat history\n                if (this.state.includeChatHistory) {\n                    var chatHistory = JSON.parse(this.state.configChatHistory);\n                    if (chatHistory === null) chatHistory = S2sEvent.DEFAULT_CHAT_HISTORY;\n                    for (const chat of chatHistory) {\n                        const chatHistoryContentName = crypto.randomUUID();\n                        this.sendEvent(S2sEvent.contentStartText(this.promptName, chatHistoryContentName, chat.role));\n                        this.sendEvent(S2sEvent.textInput(this.promptName, chatHistoryContentName, chat.content));\n                        this.sendEvent(S2sEvent.contentEnd(this.promptName, chatHistoryContentName));\n                    }\n                    \n                }\n\n                this.sendEvent(S2sEvent.contentStartAudio(this.promptName, this.audioContentName));\n              };\n\n            // Handle incoming messages\n            this.socket.onmessage = (message) => {\n                const event = JSON.parse(message.data);\n                this.handleIncomingMessage(event);\n            };\n        \n            // Handle errors\n            this.socket.onerror = (error) => {\n                this.setState({alert: \"WebSocket Error: \", error});\n                console.error(\"WebSocket Error: \", error);\n            };\n        \n            // Handle connection close\n            this.socket.onclose = () => {\n                console.log(\"WebSocket Disconnected\");\n                if (this.state.sessionStarted)\n                    this.setState({alert: \"WebSocket Disconnected\"});\n            };\n        }\n    }\n\n    startSession() {\n        // Init S2sSessionManager\n        try {\n            if (this.socket === null || this.socket.readyState !== WebSocket.OPEN) {\n                this.connectWebSocket();\n            }\n\n            // Start microphone \n            this.startMicrophone();\n\n        } catch (error) {\n            console.error('Error accessing microphone: ', error);\n        }\n    }\n      \n    async startMicrophone() {\n        try {\n            const stream = await navigator.mediaDevices.getUserMedia({\n                audio: {\n                    echoCancellation: true,\n                    noiseSuppression: true,\n                    autoGainControl: true\n                }\n            });\n    \n            const audioContext = new (window.AudioContext || window.webkitAudioContext)({\n                latencyHint: 'interactive'\n            });\n    \n            const source = audioContext.createMediaStreamSource(stream);\n            const processor = audioContext.createScriptProcessor(512, 1, 1);\n    \n            source.connect(processor);\n            processor.connect(audioContext.destination);\n    \n            const targetSampleRate = 16000;\n    \n            processor.onaudioprocess = async (e) => {\n                if (this.state.sessionStarted) {\n                    const inputBuffer = e.inputBuffer;\n    \n                    // Create an offline context for resampling\n                    const offlineContext = new OfflineAudioContext({\n                        numberOfChannels: 1,\n                        length: Math.ceil(inputBuffer.duration * targetSampleRate),\n                        sampleRate: targetSampleRate\n                    });\n    \n                    // Copy input to offline context buffer\n                    const offlineSource = offlineContext.createBufferSource();\n                    const monoBuffer = offlineContext.createBuffer(1, inputBuffer.length, inputBuffer.sampleRate);\n                    monoBuffer.copyToChannel(inputBuffer.getChannelData(0), 0);\n    \n                    offlineSource.buffer = monoBuffer;\n                    offlineSource.connect(offlineContext.destination);\n                    offlineSource.start(0);\n    \n                    // Resample and get the rendered buffer\n                    const renderedBuffer = await offlineContext.startRendering();\n                    const resampled = renderedBuffer.getChannelData(0);\n    \n                    // Convert to Int16 PCM\n                    const buffer = new ArrayBuffer(resampled.length * 2);\n                    const pcmData = new DataView(buffer);\n    \n                    for (let i = 0; i < resampled.length; i++) {\n                        const s = Math.max(-1, Math.min(1, resampled[i]));\n                        pcmData.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);\n                    }\n    \n                    // Convert to binary string and base64 encode\n                    let binary = '';\n                    for (let i = 0; i < pcmData.byteLength; i++) {\n                        binary += String.fromCharCode(pcmData.getUint8(i));\n                    }\n    \n                    const event = S2sEvent.audioInput(\n                        this.promptName,\n                        this.audioContentName,\n                        btoa(binary)\n                    );\n                    this.sendEvent(event);\n                }\n            };\n    \n            window.audioCleanup = () => {\n                processor.disconnect();\n                source.disconnect();\n                stream.getTracks().forEach(track => track.stop());\n            };\n    \n            this.mediaRecorder = new MediaRecorder(stream);\n            this.mediaRecorder.ondataavailable = (event) => {\n                this.state.audioChunks.push(event.data);\n            };\n            this.mediaRecorder.onstop = () => {\n                const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/webm' });\n                this.sendEvent(S2sEvent.audioInput(this.promptName, this.audioContentName, btoa(audioBlob)));\n                this.setState({ audioChunks: [] });\n            };\n    \n            this.mediaRecorder.start();\n            this.setState({ sessionStarted: true });\n            console.log('Microphone recording started');\n    \n        } catch (error) {\n            console.error('Error accessing microphone: ', error);\n        }\n    }\n    \n    \n\n    endSession() {\n        if (this.socket) {\n            // Close microphone\n            if (this.mediaRecorder && this.state.sessionStarted) {\n                this.mediaRecorder.stop();\n                console.log('Microphone recording stopped');\n            }\n\n            // Close S2sSessionManager\n            this.sendEvent(S2sEvent.contentEnd(this.promptName, this.audioContentName));\n            this.sendEvent(S2sEvent.promptEnd(this.promptName));\n            this.sendEvent(S2sEvent.sessionEnd());\n\n            // Close websocket\n            this.socket.close();\n\n            this.setState({\n                sessionStarted: false,\n            });\n\n        }\n  \n    }\n    render() {\n        return (\n            <div className=\"s2s\">\n                {this.state.alert !== null && this.state.alert.length > 0?\n                <div><Alert statusIconAriaLabel=\"Warning\" type=\"warning\">\n                {this.state.alert}\n                </Alert><br/></div>:<div/>}\n                <div className='top'>\n                    <div className='action'>\n                        <Button variant='primary' onClick={this.handleSessionChange}>\n                            <Icon name={this.state.sessionStarted?\"microphone-off\":\"microphone\"} />&nbsp;&nbsp;\n                            {this.state.sessionStarted?\"End Conversation\":\"Start Conversation\"}\n                        </Button>\n                        <div className='chathistory'>\n                            <Checkbox checked={this.state.includeChatHistory} onChange={({ detail }) => this.setState({includeChatHistory: detail.checked})}>Include chat history</Checkbox>\n                            <div className='desc'>You can view sample chat history in the settings.</div>\n                        </div>\n                        <audio ref={this.audioPlayerRef}></audio>\n                    </div>\n                    <div className='setting'>\n                        <Button onClick={()=> \n                            this.setState({\n                                showConfig: true, \n                            })\n                        }>\n                            <Icon name=\"settings\"/>\n                        </Button>\n                        \n                    </div>\n                </div>\n                <br/>\n                <ColumnLayout columns={2}>\n                    <Container header={\n                        <Header variant=\"h2\">Conversation</Header>\n                    }>\n                    <div className=\"chatarea\">\n                        {Object.keys(this.state.chatMessages).map((key,index) => {\n                            const msg = this.state.chatMessages[key];\n                            //if (msg.stopReason === \"END_TURN\" || msg.role === \"USER\")\n                                return <div className='item'>\n                                    <div className={msg.role === \"USER\"?\"user\":\"bot\"} onClick={()=> \n                                            this.setState({\n                                                showEventJson: true, \n                                                selectedEvent: {events:msg.raw}\n                                            })\n                                        }>\n                                        <Icon name={msg.role === \"USER\"?\"user-profile\":\"gen-ai\"} />&nbsp;&nbsp;\n                                        {msg.content}\n                                        {msg.role === \"ASSISTANT\" && msg.generationStage? ` [${msg.generationStage}]`:\"\"}\n                                    </div>\n                                </div>\n                        })}\n                        <div className='endbar' ref={this.chatMessagesEndRef}></div>\n                    </div>\n                    </Container>\n                    <Container header={\n                        <Header variant=\"h2\">Events</Header>\n                    }>\n                    <div className='events'>\n                        {this.state.eventsByContentName.map(event=>{\n                            return <div className={\n                                    event.name === \"toolUse\"? \"event-tool\": \n                                    event.interrupted === true?\"event-int\":\n                                    event.type === \"in\"?\"event-in\":\"event-out\"\n                                } \n                                onClick={() => {\n                                    this.setState({selectedEvent: event, showEventJson: true});\n                                }}\n                                >\n                                <Icon name={event.type === \"in\"? \"arrow-down\": \"arrow-up\"} />&nbsp;&nbsp;\n                                {event.name}\n                                {event.events.length > 1? ` (${event.events.length})`: \"\"}\n                                <div class=\"tooltip\">\n                                    <pre id=\"jsonDisplay\">{event.events.map(e=>{\n                                        return JSON.stringify(e,null,2);\n                                    })\n                                }</pre>\n                                </div>\n                            </div>\n                        })}\n                        <Modal\n                            onDismiss={() => this.setState({showEventJson: false})}\n                            visible={this.state.showEventJson}\n                            header=\"Event details\"\n                            size='medium'\n                            footer={\n                                <Box float=\"right\">\n                                <SpaceBetween direction=\"horizontal\" size=\"xs\">\n                                    <Button variant=\"link\" onClick={() => this.setState({showEventJson: false})}>Close</Button>\n                                </SpaceBetween>\n                                </Box>\n                            }\n                        >\n                            <div className='eventdetail'>\n                            <pre id=\"jsonDisplay\">\n                                {this.state.selectedEvent && this.state.selectedEvent.events.map(e=>{\n                                    const eventType = Object.keys(e?.event)[0];\n                                    if (eventType === \"audioInput\" || eventType === \"audioOutput\")\n                                        e.event[eventType].content = e.event[eventType].content.substr(0,10) + \"...\";\n                                    const ts = new Date(e.timestamp).toLocaleString(undefined, {\n                                        year: \"numeric\",\n                                        month: \"2-digit\",\n                                        day: \"2-digit\",\n                                        hour: \"2-digit\",\n                                        minute: \"2-digit\",\n                                        second: \"2-digit\",\n                                        fractionalSecondDigits: 3, // Show milliseconds\n                                        hour12: false // 24-hour format\n                                    });\n                                    var displayJson = { ...e };\n                                    delete displayJson.timestamp;\n                                    return ts + \"\\n\" + JSON.stringify(displayJson,null,2) + \"\\n\";\n                                })}\n                            </pre>\n                            </div>\n                        </Modal>\n                        <Modal\n                            onDismiss={() => this.setState({showConfig: false})}\n                            visible={this.state.showConfig}\n                            header=\"Nova S2S settings\"\n                            size='large'\n                            footer={\n                                <Box float=\"right\">\n                                <SpaceBetween direction=\"horizontal\" size=\"xs\">\n                                    <Button variant=\"link\" onClick={() => this.setState({showConfig: false})}>Save</Button>\n                                </SpaceBetween>\n                                </Box>\n                            }\n                        >\n                            <div className='config'>\n                                <FormField\n                                    label=\"Voice Id\"\n                                    stretch={true}\n                                >\n                                    <Select\n                                        selectedOption={this.state.configVoiceIdOption}\n                                        onChange={({ detail }) =>\n                                            this.setState({configVoiceIdOption: detail.selectedOption})\n                                        }\n                                        options={[\n                                            { label: \"Matthew (en-US)\", value: \"matthew\" },\n                                            { label: \"Tiffany (en-US)\", value: \"tiffany\" },\n                                            { label: \"Amy (en-GB)\", value: \"amy\" },\n                                        ]}\n                                        />\n                                </FormField>\n                                <br/>\n                                <FormField\n                                    label=\"System prompt\"\n                                    description=\"For the speech model\"\n                                    stretch={true}\n                                >\n                                    <Textarea\n                                        onChange={({ detail }) => this.setState({configSystemPrompt: detail.value})}\n                                        value={this.state.configSystemPrompt}\n                                        placeholder=\"Speech system prompt\"\n                                    />\n                                </FormField>\n                                <br/>\n                                <FormField\n                                    label=\"Tool use configuration\"\n                                    description=\"For external integration such as RAG and Agents\"\n                                    stretch={true}\n                                >\n                                    <Textarea\n                                        onChange={({ detail }) => this.setState({configToolUse: detail.value})}\n                                        value={this.state.configToolUse}\n                                        rows={10}\n                                        placeholder=\"{}\"\n                                    />\n                                </FormField>\n                                        <br/>\n                                <FormField\n                                    label=\"Chat history\"\n                                    description=\"Sample chat history to resume conversation\"\n                                    stretch={true}\n                                >\n                                    <Textarea\n                                        onChange={({ detail }) => this.setState({configChatHistory: detail.value})}\n                                        value={this.state.configChatHistory}\n                                        rows={15}\n                                        placeholder=\"{}\"\n                                    />\n                                </FormField>\n                            </div>\n                        </Modal>\n                    </div>\n                    </Container>\n                </ColumnLayout>\n            </div>\n        );\n    }\n}\n\nexport default S2sChatBot;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}